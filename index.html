<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>v2ray-docker</title>
    <meta property="og:title" content="v2ray deploy by docker">
    <meta property="og:locale" content="en_US">
    <meta name="description" content="v2ray deploy by docker">
    <meta property="og:description" content="v2ray deploy by docker">
    <link rel="canonical" href="https://alanhe421.github.io/v2ray-docker/">
    <meta property="og:url" content="https://alanhe421.github.io/v2ray-docker/">
    <meta property="og:site_name" content="v2ray-docker">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta property="twitter:title" content="v2ray deploy by docker">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&amp;display=swap" as="style"
          type="text/css" crossorigin="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="lib/style.css?v=e4efdad7226cfcfaeed3371995a7a4e58293be7d">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

    <!-- Setup Google Analytics -->


    <!-- You can set your favicon here -->
    <link rel="shortcut icon" type="image/x-icon" href="/v2ray-docker/favicon.ico" >
    <link rel="manifest" href="/v2ray-docker/site.webmanifest">
    <!-- end custom head snippets -->

    <script src="lib/jszip.min.js"></script>
    <script src="lib/uuid.min.js"></script>
    <script src="lib/clipboard.min.js"></script>

</head>
<body data-new-gr-c-s-check-loaded="14.1062.0" data-gr-ext-installed="">

<header class="page-header" role="banner">
    <h1 class="project-name">v2ray-docker</h1>
    <h2 class="project-tagline">快速搭建代理服务
    </h2>
</header>
<main id="content" class="main-content" role="main">
    <ul>
        <li>
            时间也是钱，如果不愿意折腾配置，推荐<a href="https://portal.shadowsocks.nz/aff.php?aff=27252">机场</a>，自用即可，不要广泛传播。
        </li>
        <li>
            针对VPS机器，推荐<a href="https://www.vultr.com/?ref=8363373">Vultr</a>，优点支持按时间收费且不存在被封风险，各有优点，任君选。
        </li>
        <li>
            有了VPS机器及域名，就可以按照如下步骤搞起。
        </li>
    </ul>
    <h2 id="welcome-to-github-pages">1️⃣ 配置生成</h2>
    <form id="configForm">
        <label for="domainName">
            <div class="required">
                域名
            </div>
            <input id="domainName" type="text" required/>
        </label>
        <label for="port">
            <div class="required">
                端口
            </div>
            <input id="port" type="number" required value="443"/>
        </label>
        <label for="email">
            <div class="required">
                邮箱
            </div>
            <input id="email" type="text" required/>
        </label>
        <label for="clientId">
            <div class="required">
                V2Ray ClientId即VMessID
            </div>
            <input id="clientId" type="text"/>
            <a onclick="regenerateClientId()">(重新生成)</a>
        </label>
        <label for="wsPath">
            <div class="required">
                WebSocket Path
            </div>
            <input id="wsPath" type="text" value="/helloworld" required/>
        </label>
        <label for="targetIP">
            <div>
                目标服务器IP
            </div>
            <input id="targetIP" type="text" placeholder="用于步骤2生成SCP拷贝文件命令"/>
        </label>
    </form>
    <button onclick="formSubmit()">
        下载配置
    </button>

    <h2>2️⃣ 部署</h2>

    服务器系统推荐: <span class="highlight">CentOS 7 x64</span>, 不要使用<span class="highlight">CentOS 8</span>

    <ol>
        <li>
            DNS解析增加域名A记录
        </li>
        <li>上传ZIP配置包到目标服务器
            <textarea rows="2" id="scpConfig">
                scp v2ray-docker.zip root@remote_ip:/root
            </textarea>
            <button data-clipboard-target="#scpConfig" class="copy-btn">
                复制
            </button>
        </li>
        <li>执行以下命令
            <pre><code>unzip v2ray-docker.zip
cd v2ray-docker
chmod +x ./*.sh
./init-v2ray.sh

# 速度测试
# abroad
wget -qO- bench.sh | bash

# home
wget -qO- git.io/superbench.sh | bash</code></pre>

        </li>
    </ol>
    <h2>3️⃣ 客户端App配置</h2>
    <h3>
        Surge
    </h3>
    <textarea rows="3" id="surgeConfig">
    </textarea>
    <button data-clipboard-target="#surgeConfig" class="copy-btn">
        复制
    </button>
    <h3>
        Clash
    </h3>
    <textarea rows="15" id="clashConfig">

    </textarea>
    <button data-clipboard-target="#clashConfig" class="copy-btn">
        复制
    </button>
    <h2>4️⃣ 谷歌一把 🚀</h2>
    <footer class="site-footer">

        <span class="site-footer-owner"><a href="https://github.com/alanhe421/v2ray-docker">v2ray-docker</a> is maintained by <a
                href="https://github.com/alanhe421">alanhe421</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
        <a class="sponsor" href="https://www.paypal.com/paypalme/alanhe421"><img
                src="https://img.shields.io/static/v1?label=Sponsor&message=%E2%9D%A4&logo=GitHub&color=%23fe8e86)]"/></a>
    </footer>
</main>

<template id="surgeConfigTpl">
    <textarea rows="3">
[Proxy]
proxy1 = vmess, __DomainName__, 443, username=__ClientId__, ws=true, ws-path=__WsPath__, tls=true
    </textarea>
</template>
<template id="clashConfigTpl">
  <textarea rows="15">
      proxies:
        -
          name: proxy1
          type: vmess
          server: __DomainName__
          port: __Port__
          uuid: __ClientId__
          alterId: 64
          cipher: auto
          tls: true
          skip-cert-verify: false
          servername: __DomainName__
          network: ws
          ws-opts:
            path: __WsPath__
    </textarea>
</template>

<template id="scpConfigTpl">
  <textarea rows="15">
scp v2ray-docker.zip root@__TargetIP__:/root</textarea>
</template>

<script>
  regenerateClientId();
  generateClientConfig();
  const clipboard = new ClipboardJS('.copy-btn');

  clipboard.on('success', function (e) {
    console.info('Action:', e.action);
    console.info('Text:', e.text);
    console.info('Trigger:', e.trigger);
    e.clearSelection();
    e.trigger.innerText = '已复制';
    window.setTimeout(() => {
      e.trigger.innerText = '复制';
    }, 3000);
  });

  function regenerateClientId() {
    document.getElementById('clientId').value = uuid.v4();
  }

  function saveAs(blob, filename) {
    const url = URL.createObjectURL(blob);
    const linkEl = document.createElement('a');
    linkEl.href = url;
    linkEl.download = filename;
    linkEl.click();
  }

  async function formSubmit() {
    const domainName = document.getElementById('domainName').value;
    const port = document.getElementById('port').value;
    const email = document.getElementById('email').value;
    const clientId = document.getElementById('clientId').value;
    const wsPath = document.getElementById('wsPath').value;
    const targetIp = document.getElementById('targetIP').value;
    if (!domainName || !email || !clientId || !wsPath || !port) {
      alert('All config-field is required!');
      return;
    }

    let [initV2RayFile, initDockerComposeFile, v2RayConfigFile, caddyConfigFile] = await Promise.all([
      fetch('./v2ray_config/init-v2ray.sh').then(res => res.text()),
      fetch('./v2ray_config/docker-compose.yml').then(res => res.text()),
      fetch('./v2ray_config/v2ray/config.json').then(res => res.text()),
      fetch('./v2ray_config/Caddyfile').then(res => res.text())
    ])
    const zip = new JSZip();
    const replacePattern = [
      {
        key: '__DomainName__',
        value: domainName
      },
      {
        key: '__Port__',
        value: port
      },
      {
        key: '__Email__',
        value: email
      },
      {
        key: '__ClientId__',
        value: clientId
      }, {
        key: '__WsPath__',
        value: wsPath
      },
      {
        key: '__TargetIP__',
        value: targetIp || ''
      },
    ];

    /**
     * replace template config
     */
    initV2RayFile = replaceConfig(initV2RayFile, replacePattern);
    v2RayConfigFile = replaceConfig(v2RayConfigFile, replacePattern);
    caddyConfigFile = replaceConfig(caddyConfigFile, replacePattern);

    zip.file('v2ray-docker/init-v2ray.sh', initV2RayFile);
    zip.file('v2ray-docker/docker-compose.yml', initDockerComposeFile);
    zip.file('v2ray-docker/v2ray/config.json', v2RayConfigFile);
    zip.file('v2ray-docker/Caddyfile', caddyConfigFile);

    zip.generateAsync({type: 'blob'}).then(function (content) {
      saveAs(content, 'v2ray-docker.zip');
      generateClientConfig(replacePattern);
    });
  }

  function replaceConfig(cnt, replacePattern) {
    return replacePattern.reduce((res, item) => res.replaceAll(item.key, item.value), cnt);
  }

  /**
   *
   * @param replacePattern 替换配置项数组，将指定模版字段替换为目标值
   */
  function generateClientConfig(replacePattern = []) {
    const surgeConfigEl = document.getElementById('surgeConfig');
    const clashConfigEl = document.getElementById('clashConfig');
    const scpConfigEl = document.getElementById('scpConfig');

    const surgeConfigTplEl = document.getElementById('surgeConfigTpl').content.querySelector('textarea');
    const clashConfigTplEl = document.getElementById('clashConfigTpl').content.querySelector('textarea');
    const scpConfigTpl = document.getElementById('scpConfigTpl').content.querySelector('textarea');
    if (replacePattern.length) {
      surgeConfigEl.value = replaceConfig(surgeConfigTplEl.value, replacePattern);
      clashConfigEl.value = replaceConfig(clashConfigTplEl.value, replacePattern);
      scpConfigEl.value = replaceConfig(scpConfigTpl.value, replacePattern);
    } else {
      surgeConfigEl.value = surgeConfigTplEl.value;
      clashConfigEl.value = clashConfigTplEl.value;
      scpConfigEl.value = scpConfigTpl.value;
    }
  }


</script>
</body>
</html>
